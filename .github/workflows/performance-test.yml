name: âš¡ Performance Testing

on:
  workflow_dispatch: # Permet de le lancer Ã  la main quand tu veux

jobs:
  performance-test:
    name: ğŸ“Š Test de Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ Configuration Python
        uses: actions/setup-python@v5 # MIS Ã€ JOUR de v4 Ã  v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Installation des outils
        run: pip install requests

      - name: âš¡ Test de temps de rÃ©ponse
        run: |
          API_URL="${{ secrets.API_URL || 'http://localhost:5000' }}"
          python3 << 'EOF'
          import requests
          import time
          import statistics
          api_url = "${{ secrets.API_URL || 'http://localhost:5000' }}"
          endpoints = ["/", "/health", "/metrics", "/api/articles"]
          results = {}
          for endpoint in endpoints:
              times = []
              for i in range(5):
                  try:
                      start = time.time()
                      response = requests.get(f"{api_url}{endpoint}", timeout=10)
                      if response.status_code == 200:
                          times.append((time.time() - start) * 1000)
                  except: pass
              if times:
                  avg = statistics.mean(times)
                  print(f"âœ… {endpoint}: {avg:.2f}ms")
          EOF

      - name: ğŸ”¥ Test de charge (Load Testing)
        run: |
          python3 << 'EOF'
          import requests
          import time
          from concurrent.futures import ThreadPoolExecutor
          api_url = "${{ secrets.API_URL || 'http://localhost:5000' }}"
          def make_req(i):
              try: return requests.get(f"{api_url}/api/articles", timeout=10).status_code == 200
              except: return False
          with ThreadPoolExecutor(max_workers=10) as ex:
              res = list(ex.map(make_req, range(50)))
          print(f"ğŸ”¥ SuccÃ¨s: {sum(res)}/50")
          EOF

      - name: ğŸš¨ Alerte si performance dÃ©gradÃ©e
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ Performance Degradation Detected',
              body: 'Le site est trop lent ou ne rÃ©pond plus correctement.',
              labels: ['performance', 'automated']
            });
