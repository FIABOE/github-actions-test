name: ðŸ’¾ Automated Backup

# S'exÃ©cute tous les jours Ã  minuit
on:
  schedule:
    - cron: '0 0 * * *'  # Tous les jours Ã  minuit UTC
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  backup:
    name: ðŸ’¾ Sauvegarde des DonnÃ©es
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ðŸ—“ï¸ GÃ©nÃ©rer le nom du backup
        id: backup_info
        run: |
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          BACKUP_NAME="backup_${TIMESTAMP}"
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "backup_name=$BACKUP_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“ Nom du backup: $BACKUP_NAME"
      
      - name: ðŸ’¾ CrÃ©er le backup
        run: |
          echo "ðŸ’¾ CrÃ©ation du backup..."
          
          # CrÃ©er un dossier pour le backup
          mkdir -p backups/${{ steps.backup_info.outputs.backup_name }}
          
          # Simuler la sauvegarde de diffÃ©rents Ã©lÃ©ments
          # Dans un vrai projet, vous sauvegarderiez:
          # - Base de donnÃ©es (dump SQL)
          # - Fichiers de configuration
          # - Logs importants
          # - Uploads utilisateurs
          
          # Exemple: sauvegarder les fichiers de l'application
          cp -r app/ backups/${{ steps.backup_info.outputs.backup_name }}/app/
          
          # CrÃ©er un fichier d'info sur le backup
          cat > backups/${{ steps.backup_info.outputs.backup_name }}/backup_info.txt << EOF
          ================================
          BACKUP INFORMATION
          ================================
          Timestamp: $(date)
          Commit SHA: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Triggered by: ${{ github.actor }}
          Workflow: ${{ github.workflow }}
          ================================
          EOF
          
          echo "âœ… Backup crÃ©Ã©"
      
      - name: ðŸ—œï¸ Compresser le backup
        run: |
          echo "ðŸ—œï¸ Compression du backup..."
          cd backups
          tar -czf ${{ steps.backup_info.outputs.backup_name }}.tar.gz ${{ steps.backup_info.outputs.backup_name }}
          
          # Afficher la taille
          SIZE=$(du -h ${{ steps.backup_info.outputs.backup_name }}.tar.gz | cut -f1)
          echo "ðŸ“¦ Taille du backup: $SIZE"
          echo "âœ… Backup compressÃ©"
      
      - name: ðŸ” Calculer le checksum
        id: checksum
        run: |
          echo "ðŸ” Calcul du checksum pour vÃ©rifier l'intÃ©gritÃ©..."
          cd backups
          CHECKSUM=$(sha256sum ${{ steps.backup_info.outputs.backup_name }}.tar.gz | awk '{print $1}')
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "ðŸ” Checksum: $CHECKSUM"
          
          # Sauvegarder le checksum
          echo "$CHECKSUM  ${{ steps.backup_info.outputs.backup_name }}.tar.gz" > ${{ steps.backup_info.outputs.backup_name }}.sha256
      
      - name: â˜ï¸ Upload vers le stockage
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.backup_info.outputs.backup_name }}
          path: backups/${{ steps.backup_info.outputs.backup_name }}.tar.gz
          retention-days: 30  # Conserver 30 jours
      
      - name: ðŸ“Š VÃ©rifier l'intÃ©gritÃ© du backup
        run: |
          echo "ðŸ” VÃ©rification de l'intÃ©gritÃ©..."
          cd backups
          
          # VÃ©rifier le checksum
          if sha256sum -c ${{ steps.backup_info.outputs.backup_name }}.sha256; then
            echo "âœ… IntÃ©gritÃ© du backup vÃ©rifiÃ©e"
          else
            echo "âŒ Erreur: IntÃ©gritÃ© compromise!"
            exit 1
          fi
          
          # Tester l'extraction
          echo "ðŸ§ª Test d'extraction..."
          mkdir -p test_restore
          tar -xzf ${{ steps.backup_info.outputs.backup_name }}.tar.gz -C test_restore
          
          if [ -d "test_restore/${{ steps.backup_info.outputs.backup_name }}" ]; then
            echo "âœ… Backup extractible correctement"
          else
            echo "âŒ Erreur lors de l'extraction"
            exit 1
          fi
      
      - name: ðŸ§¹ Nettoyer les vieux backups
        run: |
          echo "ðŸ§¹ Nettoyage des anciens backups..."
          
          # Dans un vrai projet, vous supprimeriez:
          # - Les backups de plus de 30 jours
          # - Les backups de plus de X GB au total
          # - En gardant au moins les 7 derniers backups
          
          echo "â„¹ï¸ Politique de rÃ©tention:"
          echo "  - Conserver les 30 derniers jours"
          echo "  - Garder 1 backup par semaine pour les 3 derniers mois"
          echo "  - Garder 1 backup par mois pour l'annÃ©e"
          
          echo "âœ… Nettoyage effectuÃ©"
      
      - name: ðŸ“§ PrÃ©parer le rapport de backup
        run: |
          cat > backup-report.txt << EOF
          ================================
          ðŸ“Š BACKUP REPORT
          ================================
          ðŸ—“ï¸  Date: $(date)
          ðŸ“¦ Nom: ${{ steps.backup_info.outputs.backup_name }}
          ðŸ” Checksum: ${{ steps.checksum.outputs.checksum }}
          âœ… Status: SUCCESS
          
          ðŸ“ Contenu sauvegardÃ©:
          - Application code
          - Configuration files
          - Database (si applicable)
          
          â˜ï¸  Stockage:
          - GitHub Artifacts (30 jours)
          
          ðŸ”„ Prochain backup: $(date -d "+1 day" +"%Y-%m-%d %H:%M")
          ================================
          EOF
          
          cat backup-report.txt
      
      - name: ðŸ“¤ Upload du rapport
        uses: actions/upload-artifact@v3
        with:
          name: backup-report-${{ steps.backup_info.outputs.timestamp }}
          path: backup-report.txt
          retention-days: 90
      
      # Dans un vrai projet, vous enverriez aussi un email ici
      
  # ==================== VÃ‰RIFICATION ====================
  verify:
    name: âœ… VÃ©rification du Backup
    runs-on: ubuntu-latest
    needs: [backup]
    
    steps:
      - name: ðŸ“¥ TÃ©lÃ©charger le backup
        uses: actions/download-artifact@v3
        with:
          name: ${{ needs.backup.outputs.backup_name || 'backup' }}
      
      - name: ðŸ” VÃ©rifier le backup tÃ©lÃ©chargÃ©
        run: |
          echo "ðŸ” VÃ©rification du backup tÃ©lÃ©chargÃ©..."
          
          # Lister les fichiers tÃ©lÃ©chargÃ©s
          echo "ðŸ“ Fichiers prÃ©sents:"
          ls -lh
          
          echo "âœ… Backup vÃ©rifiÃ© et accessible"
  
  # ==================== RÃ‰SUMÃ‰ ====================
  summary:
    name: ðŸ“Š RÃ©sumÃ© du Backup
    runs-on: ubuntu-latest
    needs: [backup, verify]
    if: always()
    
    steps:
      - name: ðŸ“Š Afficher le rÃ©sumÃ©
        run: |
          echo "================================"
          echo "ðŸ’¾ BACKUP SUMMARY"
          echo "================================"
          echo "Backup: ${{ needs.backup.result }}"
          echo "Verification: ${{ needs.verify.result }}"
          echo "Timestamp: $(date)"
          echo "================================"
          
          if [ "${{ needs.backup.result }}" = "success" ] && [ "${{ needs.verify.result }}" = "success" ]; then
            echo "âœ… Backup rÃ©ussi et vÃ©rifiÃ©"
          else
            echo "âš ï¸ ProblÃ¨me dÃ©tectÃ© lors du backup"
          fi
          
          echo ""
          echo "ðŸ“Š Statistiques:"
          echo "  - FrÃ©quence: Quotidienne"
          echo "  - RÃ©tention: 30 jours"
          echo "  - VÃ©rification: Automatique"
      
      - name: ðŸš¨ Alerte si Ã©chec du backup
        if: needs.backup.result == 'failure' || needs.verify.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ’¾ Backup Failed';
            const body = `
            ## ðŸ’¾ Alerte: Ã‰chec du Backup
            
            **Timestamp:** ${new Date().toISOString()}
            
            Le backup automatique a Ã©chouÃ©.
            
            ### Statuts:
            - Backup: ${{ needs.backup.result }}
            - Verification: ${{ needs.verify.result }}
            
            ### Actions recommandÃ©es:
            - [ ] VÃ©rifier les logs du workflow
            - [ ] VÃ©rifier l'espace de stockage
            - [ ] Relancer le backup manuellement
            - [ ] Investiguer la cause de l'Ã©chec
            
            **DÃ©tails:** ${context.payload.repository.html_url}/actions/runs/${context.runId}
            
            âš ï¸ **IMPORTANT:** VÃ©rifiez que vous avez des backups rÃ©cents valides!
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['backup', 'critical', 'automated']
            });
