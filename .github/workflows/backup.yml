name: ğŸ’¾ Automated Backup

on:
  schedule:
    - cron: '0 0 * * *'  # Tous les jours Ã  minuit UTC
  workflow_dispatch:

jobs:
  backup:
    name: ğŸ’¾ Sauvegarde des DonnÃ©es
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ—“ï¸ GÃ©nÃ©rer le nom du backup
        id: backup_info
        run: |
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          BACKUP_NAME="backup_${TIMESTAMP}"
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "backup_name=$BACKUP_NAME" >> $GITHUB_OUTPUT
      
      - name: ğŸ’¾ CrÃ©er le backup
        run: |
          mkdir -p backups/${{ steps.backup_info.outputs.backup_name }}
          cp -r app/ backups/${{ steps.backup_info.outputs.backup_name }}/app/
          echo "Backup created at $(date)" > backups/${{ steps.backup_info.outputs.backup_name }}/backup_info.txt
      
      - name: ğŸ—œï¸ Compresser le backup
        run: |
          cd backups
          tar -czf ${{ steps.backup_info.outputs.backup_name }}.tar.gz ${{ steps.backup_info.outputs.backup_name }}
      
      - name: ğŸ” Calculer le checksum
        id: checksum
        run: |
          cd backups
          CHECKSUM=$(sha256sum ${{ steps.backup_info.outputs.backup_name }}.tar.gz | awk '{print $1}')
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "$CHECKSUM  ${{ steps.backup_info.outputs.backup_name }}.tar.gz" > ${{ steps.backup_info.outputs.backup_name }}.sha256
      
      - name: â˜ï¸ Upload vers le stockage
        uses: actions/upload-artifact@v4 # MIS Ã€ JOUR
        with:
          name: ${{ steps.backup_info.outputs.backup_name }}
          path: backups/${{ steps.backup_info.outputs.backup_name }}.tar.gz
          retention-days: 30
      
      - name: ğŸ“¤ Upload du rapport
        uses: actions/upload-artifact@v4 # MIS Ã€ JOUR
        with:
          name: backup-report-${{ steps.backup_info.outputs.timestamp }}
          path: backups/${{ steps.backup_info.outputs.backup_name }}.sha256
          retention-days: 90

  verify:
    name: âœ… VÃ©rification du Backup
    runs-on: ubuntu-latest
    needs: [backup]
    steps:
      - name: ğŸ“¥ TÃ©lÃ©charger le backup
        uses: actions/download-artifact@v4 # MIS Ã€ JOUR
        with:
          name: ${{ needs.backup.outputs.backup_name }}
      
      - name: ğŸ” VÃ©rifier le backup
        run: ls -lh
