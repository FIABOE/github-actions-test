name: üè• Health Check

# S'ex√©cute toutes les 5 minutes
on:
     schedule:
       - cron: '0 * * * *'  # Toutes les heures
     workflow_dispatch:
jobs:
  health-check:
    name: üîç V√©rification de Sant√©
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
      
      - name: üåê Ping du endpoint /health
        id: health_check
        run: |
          # URL de votre API (√† remplacer par votre vraie URL)
          API_URL="${{ secrets.API_URL || 'http://localhost:5000' }}"
          
          echo "üîç V√©rification de $API_URL/health"
          
          # Faire la requ√™te avec timeout de 10 secondes
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$API_URL/health" || echo "000")
          
          echo "üìä Code HTTP: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ API est UP et fonctionne correctement!"
            echo "status=UP" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "üö® API est DOWN! Code: $HTTP_CODE"
            echo "status=DOWN" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: üìä V√©rifier les m√©triques
        if: steps.health_check.outputs.status == 'UP'
        run: |
          API_URL="${{ secrets.API_URL || 'http://localhost:5000' }}"
          
          echo "üìä R√©cup√©ration des m√©triques..."
          METRICS=$(curl -s "$API_URL/metrics" || echo "{}")
          
          echo "M√©triques:"
          echo "$METRICS" | python3 -m json.tool || echo "Impossible de parser les m√©triques"
      
      - name: üö® Alerte si DOWN
        if: failure()
        run: |
          echo "==============================================="
          echo "üö® ALERTE: API DOWN D√âTECT√âE"
          echo "==============================================="
          echo "üïí Timestamp: $(date)"
          echo "üåê URL: ${{ secrets.API_URL || 'http://localhost:5000' }}"
          echo "‚ùå L'API ne r√©pond pas correctement"
          echo "==============================================="
          
          # Dans un vrai projet, vous enverriez un email ici
          # Voir le workflow d'envoi d'email s√©par√©
      
      - name: üìù Cr√©er un issue si probl√®me persiste
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® API Health Check Failed';
            const body = `
            ## üö® Alerte: API DOWN
            
            **Timestamp:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            
            L'API ne r√©pond pas au health check.
            
            ### Actions recommand√©es:
            - [ ] V√©rifier les logs du serveur
            - [ ] V√©rifier l'√©tat des services
            - [ ] Red√©marrer l'application si n√©cessaire
            
            **Lien vers le workflow:** ${context.payload.repository.html_url}/actions/runs/${context.runId}
            `;
            
            // V√©rifier si un issue similaire existe d√©j√†
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['health-check', 'incident']
            });
            
            if (issues.data.length === 0) {
              // Cr√©er un nouvel issue seulement si aucun n'existe
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['health-check', 'incident', 'automated']
              });
              console.log('‚úÖ Issue cr√©√© pour signaler le probl√®me');
            } else {
              console.log('‚ÑπÔ∏è Un issue existe d√©j√† pour ce probl√®me');
            }

  # ==================== JOB: R√âSUM√â ====================
  summary:
    name: üìä R√©sum√©
    runs-on: ubuntu-latest
    needs: [health-check]
    if: always()
    
    steps:
      - name: üìä Afficher le r√©sum√©
        run: |
          echo "================================"
          echo "üìä HEALTH CHECK SUMMARY"
          echo "================================"
          echo "Statut: ${{ needs.health-check.result }}"
          echo "Timestamp: $(date)"
          echo "================================"
          
          if [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "‚úÖ Tout fonctionne correctement"
          else
            echo "‚ùå Des probl√®mes ont √©t√© d√©tect√©s"
          fi
