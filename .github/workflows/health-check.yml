name: Health Check

on:
  schedule:
    - cron: '0 12 * * *'  # S'exécute UNE SEULE FOIS par jour à midi (au lieu de toutes les 5 min)
  workflow_dispatch:      # Te permet de le lancer à la main pour tester

jobs:
  health-check:
    name: Vérification de Santé
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Ping du endpoint /health
        id: health_check
        run: |
          # IMPORTANT : Remplace 'http://localhost:5000' par l'adresse de ton site réel plus tard
          API_URL="${{ secrets.API_URL || 'http://localhost:5000' }}"
          
          echo "Vérification de $API_URL/health"
          
          # On tente de joindre le site. Si ça échoue, on ne panique pas tout de suite (continue-on-error)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$API_URL/health" || echo "000")
          
          echo " Code HTTP: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo " Le site répond parfaitement !"
            exit 0
          else
            echo " Le site ne répond pas (Code: $HTTP_CODE). C'est normal si vous n'avez pas encore déployé sur internet."
            # On met exit 0 pour ne pas recevoir de mail d'erreur tant que le site n'est pas en ligne
            exit 0 
          fi

  summary:
    name: Résumé
    runs-on: ubuntu-latest
    needs: [health-check]
    if: always()
    steps:
      - name: Afficher le résumé dans les logs
        run: |
          echo "Dernière vérification terminée le $(date)"
