name: ğŸ”’ Security Scan

# S'exÃ©cute quotidiennement Ã  2h du matin
on:
  schedule:
    - cron: '0 2 * * *'  # Tous les jours Ã  2h UTC
  workflow_dispatch:  # Permet de lancer manuellement
  push:
    branches: [ main ]

jobs:
  security-scan:
    name: ğŸ” Analyse de SÃ©curitÃ©
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ Configuration Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety bandit
      
      # ==================== SCAN DES DÃ‰PENDANCES ====================
      - name: ğŸ” Scan des vulnÃ©rabilitÃ©s (Safety)
        id: safety_check
        continue-on-error: true
        run: |
          echo "ğŸ” VÃ©rification des vulnÃ©rabilitÃ©s dans les dÃ©pendances..."
          safety check --json > safety-report.json || true
          
          # Afficher le rapport
          if [ -f safety-report.json ]; then
            echo "ğŸ“Š Rapport Safety:"
            cat safety-report.json | python3 -m json.tool || cat safety-report.json
          fi
      
      - name: ğŸ“Š Analyser le rapport Safety
        if: always()
        run: |
          if [ -f safety-report.json ]; then
            python3 << 'EOF'
          import json
          
          try:
              with open('safety-report.json', 'r') as f:
                  data = json.load(f)
              
              if isinstance(data, list) and len(data) > 0:
                  print(f"âš ï¸ {len(data)} vulnÃ©rabilitÃ©(s) dÃ©tectÃ©e(s)!")
                  for vuln in data[:5]:  # Afficher max 5
                      print(f"\nğŸ“¦ Package: {vuln.get('package', 'Unknown')}")
                      print(f"ğŸ”¢ Version: {vuln.get('installed_version', 'Unknown')}")
                      print(f"âš ï¸ Severity: {vuln.get('severity', 'Unknown')}")
                      print(f"ğŸ“ {vuln.get('advisory', 'No description')[:100]}...")
              else:
                  print("âœ… Aucune vulnÃ©rabilitÃ© dÃ©tectÃ©e dans les dÃ©pendances!")
          except Exception as e:
              print(f"â„¹ï¸ Analyse du rapport: {str(e)}")
          EOF
          fi
      
      # ==================== ANALYSE STATIQUE DU CODE ====================
      - name: ğŸ” Analyse statique du code (Bandit)
        id: bandit_check
        continue-on-error: true
        run: |
          echo "ğŸ” Analyse de sÃ©curitÃ© du code Python..."
          bandit -r app/ -f json -o bandit-report.json || true
          
          # Afficher le rÃ©sumÃ©
          if [ -f bandit-report.json ]; then
            echo "ğŸ“Š Rapport Bandit:"
            cat bandit-report.json | python3 -m json.tool | head -n 50
          fi
      
      - name: ğŸ“Š Analyser le rapport Bandit
        if: always()
        run: |
          if [ -f bandit-report.json ]; then
            python3 << 'EOF'
          import json
          
          try:
              with open('bandit-report.json', 'r') as f:
                  data = json.load(f)
              
              metrics = data.get('metrics', {})
              results = data.get('results', [])
              
              print("="*50)
              print("ğŸ”’ BANDIT SECURITY REPORT")
              print("="*50)
              
              # Statistiques globales
              total_loc = sum(m.get('loc', 0) for m in metrics.values())
              print(f"ğŸ“ Lines of code analyzed: {total_loc}")
              print(f"ğŸ” Issues found: {len(results)}")
              
              # Compter par sÃ©vÃ©ritÃ©
              severity_counts = {}
              for result in results:
                  severity = result.get('issue_severity', 'UNKNOWN')
                  severity_counts[severity] = severity_counts.get(severity, 0) + 1
              
              if severity_counts:
                  print("\nğŸ“Š By Severity:")
                  for severity, count in sorted(severity_counts.items()):
                      emoji = "ğŸ”´" if severity == "HIGH" else "ğŸŸ¡" if severity == "MEDIUM" else "ğŸ”µ"
                      print(f"  {emoji} {severity}: {count}")
              
              # Afficher les problÃ¨mes les plus graves
              high_issues = [r for r in results if r.get('issue_severity') == 'HIGH']
              if high_issues:
                  print("\nâš ï¸ HIGH SEVERITY ISSUES:")
                  for issue in high_issues[:3]:
                      print(f"\n  ğŸ“ File: {issue.get('filename', 'Unknown')}")
                      print(f"  ğŸ“ Line: {issue.get('line_number', '?')}")
                      print(f"  âš ï¸ Issue: {issue.get('issue_text', 'No description')}")
              else:
                  print("\nâœ… No high severity issues found!")
              
              print("="*50)
          except Exception as e:
              print(f"â„¹ï¸ Analyse du rapport: {str(e)}")
          EOF
          fi
      
      # ==================== SCAN DES SECRETS ====================
      - name: ğŸ” Scan des secrets et tokens
        run: |
          echo "ğŸ” Recherche de secrets accidentellement commitÃ©s..."
          
          # Patterns courants de secrets
          echo "Recherche de patterns suspects..."
          
          # API Keys
          grep -r -n "api[_-]?key.*=.*['\"][a-zA-Z0-9]{20,}['\"]" app/ || echo "âœ… Pas d'API keys dÃ©tectÃ©es"
          
          # Passwords
          grep -r -n "password.*=.*['\"][^'\"]{8,}['\"]" app/ || echo "âœ… Pas de mots de passe en dur"
          
          # AWS Keys
          grep -r -n "AKIA[0-9A-Z]{16}" app/ || echo "âœ… Pas de clÃ©s AWS dÃ©tectÃ©es"
          
          echo "âœ… Scan des secrets terminÃ©"
      
      # ==================== GÃ‰NÃ‰RER LE RAPPORT ====================
      - name: ğŸ“Š GÃ©nÃ©rer le rapport de sÃ©curitÃ©
        if: always()
        run: |
          echo "================================" > security-summary.txt
          echo "ğŸ”’ SECURITY SCAN SUMMARY" >> security-summary.txt
          echo "================================" >> security-summary.txt
          echo "ğŸ•’ Timestamp: $(date)" >> security-summary.txt
          echo "" >> security-summary.txt
          echo "ğŸ“Š Results:" >> security-summary.txt
          echo "  - Safety Check: ${{ steps.safety_check.outcome }}" >> security-summary.txt
          echo "  - Bandit Check: ${{ steps.bandit_check.outcome }}" >> security-summary.txt
          echo "================================" >> security-summary.txt
          
          cat security-summary.txt
      
      - name: ğŸ“¤ Upload des rapports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            safety-report.json
            bandit-report.json
            security-summary.txt
          retention-days: 30
      
      # ==================== ALERTE SI PROBLÃˆMES CRITIQUES ====================
      - name: ğŸš¨ CrÃ©er un issue si vulnÃ©rabilitÃ©s critiques
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸ”’ Security Vulnerabilities Detected';
            const body = `
            ## ğŸ”’ Alerte SÃ©curitÃ©
            
            **Timestamp:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            
            Des vulnÃ©rabilitÃ©s de sÃ©curitÃ© ont Ã©tÃ© dÃ©tectÃ©es dans le code ou les dÃ©pendances.
            
            ### Actions recommandÃ©es:
            - [ ] Consulter les rapports de sÃ©curitÃ© (artifacts)
            - [ ] Mettre Ã  jour les dÃ©pendances vulnÃ©rables
            - [ ] Corriger les problÃ¨mes de code identifiÃ©s
            - [ ] Re-scanner aprÃ¨s corrections
            
            ### Rapports disponibles:
            - Safety Report (dÃ©pendances)
            - Bandit Report (code Python)
            
            **DÃ©tails:** ${context.payload.repository.html_url}/actions/runs/${context.runId}
            `;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security']
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'high-priority', 'automated']
              });
              console.log('âœ… Security issue created');
            } else {
              console.log('â„¹ï¸ Security issue already exists');
            }

  # ==================== RÃ‰SUMÃ‰ ====================
  summary:
    name: ğŸ“Š RÃ©sumÃ© SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: [security-scan]
    if: always()
    
    steps:
      - name: ğŸ“Š Afficher le rÃ©sumÃ©
        run: |
          echo "================================"
          echo "ğŸ”’ SECURITY SCAN COMPLETE"
          echo "================================"
          echo "Status: ${{ needs.security-scan.result }}"
          echo "Timestamp: $(date)"
          echo "================================"
          
          if [ "${{ needs.security-scan.result }}" = "success" ]; then
            echo "âœ… Aucun problÃ¨me critique dÃ©tectÃ©"
          else
            echo "âš ï¸ Des problÃ¨mes de sÃ©curitÃ© nÃ©cessitent votre attention"
          fi
