name: Security Scan

# S'ex√©cute quotidiennement √† 2h du matin
on:
  schedule:
    - cron: '0 2 * * *'  # Tous les jours √† 2h UTC
  workflow_dispatch:  # Permet de lancer manuellement
  push:
    branches: [ main ]

jobs:
  security-scan:
    name:  Analyse de S√©curit√©
    runs-on: ubuntu-latest
    
    steps:
      - name:  Checkout du code
        uses: actions/checkout@v4
      
      - name:  Configuration Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name:  Installation des d√©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety bandit
      
      # ==================== SCAN DES D√âPENDANCES ====================
      - name:  Scan des vuln√©rabilit√©s (Safety)
        id: safety_check
        continue-on-error: true
        run: |
          echo " V√©rification des vuln√©rabilit√©s dans les d√©pendances..."
          safety check --json > safety-report.json || true
          
          # Afficher le rapport
          if [ -f safety-report.json ]; then
            echo "Rapport Safety:"
            cat safety-report.json | python3 -m json.tool || cat safety-report.json
          fi
      
      - name:  Analyser le rapport Safety
        if: always()
        run: |
          if [ -f safety-report.json ]; then
            python3 << 'EOF'
          import json
          
          try:
              with open('safety-report.json', 'r') as f:
                  data = json.load(f)
              
              if isinstance(data, list) and len(data) > 0:
                  print(f" {len(data)} vuln√©rabilit√©(s) d√©tect√©e(s)!")
                  for vuln in data[:5]:  # Afficher max 5
                      print(f"\n Package: {vuln.get('package', 'Unknown')}")
                      print(f"Version: {vuln.get('installed_version', 'Unknown')}")
                      print(f" Severity: {vuln.get('severity', 'Unknown')}")
                      print(f" {vuln.get('advisory', 'No description')[:100]}...")
              else:
                  print(" Aucune vuln√©rabilit√© d√©tect√©e dans les d√©pendances!")
          except Exception as e:
              print(f"‚Ñπ Analyse du rapport: {str(e)}")
          EOF
          fi
      
      # ==================== ANALYSE STATIQUE DU CODE ====================
      - name:  Analyse statique du code (Bandit)
        id: bandit_check
        continue-on-error: true
        run: |
          echo " Analyse de s√©curit√© du code Python..."
          bandit -r app/ -f json -o bandit-report.json || true
          
          # Afficher le r√©sum√©
          if [ -f bandit-report.json ]; then
            echo " Rapport Bandit:"
            cat bandit-report.json | python3 -m json.tool | head -n 50
          fi
      
      - name:  Analyser le rapport Bandit
        if: always()
        run: |
          if [ -f bandit-report.json ]; then
            python3 << 'EOF'
          import json
          
          try:
              with open('bandit-report.json', 'r') as f:
                  data = json.load(f)
              
              metrics = data.get('metrics', {})
              results = data.get('results', [])
              
              print("="*50)
              print(" BANDIT SECURITY REPORT")
              print("="*50)
              
              # Statistiques globales
              total_loc = sum(m.get('loc', 0) for m in metrics.values())
              print(f" Lines of code analyzed: {total_loc}")
              print(f" Issues found: {len(results)}")
              
              # Compter par s√©v√©rit√©
              severity_counts = {}
              for result in results:
                  severity = result.get('issue_severity', 'UNKNOWN')
                  severity_counts[severity] = severity_counts.get(severity, 0) + 1
              
              if severity_counts:
                  print("\nüìä By Severity:")
                  for severity, count in sorted(severity_counts.items()):
                      emoji = "üî¥" if severity == "HIGH" else "üü°" if severity == "MEDIUM" else "üîµ"
                      print(f"  {emoji} {severity}: {count}")
              
              # Afficher les probl√®mes les plus graves
              high_issues = [r for r in results if r.get('issue_severity') == 'HIGH']
              if high_issues:
                  print("\n HIGH SEVERITY ISSUES:")
                  for issue in high_issues[:3]:
                      print(f"\n File: {issue.get('filename', 'Unknown')}")
                      print(f"  Line: {issue.get('line_number', '?')}")
                      print(f"  Issue: {issue.get('issue_text', 'No description')}")
              else:
                  print("\n No high severity issues found!")
              
              print("="*50)
          except Exception as e:
              print(f" Analyse du rapport: {str(e)}")
          EOF
          fi
      
      # ==================== SCAN DES SECRETS ====================
      - name:  Scan des secrets et tokens
        run: |
          echo " Recherche de secrets accidentellement commit√©s..."
          
          # Patterns courants de secrets
          echo "Recherche de patterns suspects..."
          
          # API Keys
          grep -r -n "api[_-]?key.*=.*['\"][a-zA-Z0-9]{20,}['\"]" app/ || echo " Pas d'API keys d√©tect√©es"
          
          # Passwords
          grep -r -n "password.*=.*['\"][^'\"]{8,}['\"]" app/ || echo " Pas de mots de passe en dur"
          
          # AWS Keys
          grep -r -n "AKIA[0-9A-Z]{16}" app/ || echo " Pas de cl√©s AWS d√©tect√©es"
          
          echo " Scan des secrets termin√©"
      
      # ==================== G√âN√âRER LE RAPPORT ====================
      - name:  G√©n√©rer le rapport de s√©curit√©
        if: always()
        run: |
          echo "================================" > security-summary.txt
          echo " SECURITY SCAN SUMMARY" >> security-summary.txt
          echo "================================" >> security-summary.txt
          echo " Timestamp: $(date)" >> security-summary.txt
          echo "" >> security-summary.txt
          echo " Results:" >> security-summary.txt
          echo "  - Safety Check: ${{ steps.safety_check.outcome }}" >> security-summary.txt
          echo "  - Bandit Check: ${{ steps.bandit_check.outcome }}" >> security-summary.txt
          echo "================================" >> security-summary.txt
          
          cat security-summary.txt
      
      - name:  Upload des rapports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            safety-report.json
            bandit-report.json
            security-summary.txt
          retention-days: 30
      
      # ==================== ALERTE SI PROBL√àMES CRITIQUES ====================
      - name: Cr√©er un issue si vuln√©rabilit√©s critiques
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = ' Security Vulnerabilities Detected';
            const body = `
            ##  Alerte S√©curit√©
            
            **Timestamp:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            
            Des vuln√©rabilit√©s de s√©curit√© ont √©t√© d√©tect√©es dans le code ou les d√©pendances.
            
            ### Actions recommand√©es:
            - [ ] Consulter les rapports de s√©curit√© (artifacts)
            - [ ] Mettre √† jour les d√©pendances vuln√©rables
            - [ ] Corriger les probl√®mes de code identifi√©s
            - [ ] Re-scanner apr√®s corrections
            
            ### Rapports disponibles:
            - Safety Report (d√©pendances)
            - Bandit Report (code Python)
            
            **D√©tails:** ${context.payload.repository.html_url}/actions/runs/${context.runId}
            `;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security']
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'high-priority', 'automated']
              });
              console.log(' Security issue created');
            } else {
              console.log('‚Ñπ Security issue already exists');
            }

  summary:
    name:  R√©sum√© S√©curit√©
    runs-on: ubuntu-latest
    needs: [security-scan]
    if: always()
    
    steps:
      - name:  Afficher le r√©sum√©
        run: |
          echo "================================"
          echo " SECURITY SCAN COMPLETE"
          echo "================================"
          echo "Status: ${{ needs.security-scan.result }}"
          echo "Timestamp: $(date)"
          echo "================================"
          
          if [ "${{ needs.security-scan.result }}" = "success" ]; then
            echo " Aucun probl√®me critique d√©tect√©"
          else
            echo " Des probl√®mes de s√©curit√© n√©cessitent votre attention"
          fi
