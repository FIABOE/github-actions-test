name: ğŸ“Š Weekly Report

# S'exÃ©cute tous les lundis Ã  9h
on:
  schedule:
    - cron: '0 9 * * 1'  # Tous les lundis Ã  9h UTC
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  generate-report:
    name: ğŸ“ˆ GÃ©nÃ©ration du Rapport
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ Configuration Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“Š Collecter les donnÃ©es de la semaine
        id: collect_data
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Calculer la pÃ©riode (7 derniers jours)
            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            
            console.log(`ğŸ“… PÃ©riode: ${weekAgo.toISOString()} â†’ ${now.toISOString()}`);
            
            // RÃ©cupÃ©rer les commits de la semaine
            const commits = await github.rest.repos.listCommits({
              owner,
              repo,
              since: weekAgo.toISOString(),
              per_page: 100
            });
            
            // RÃ©cupÃ©rer les workflows runs
            const workflowRuns = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              created: `>=${weekAgo.toISOString().split('T')[0]}`,
              per_page: 100
            });
            
            // RÃ©cupÃ©rer les issues de la semaine
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              since: weekAgo.toISOString(),
              state: 'all',
              per_page: 100
            });
            
            // RÃ©cupÃ©rer les Pull Requests
            const prs = await github.rest.pulls.list({
              owner,
              repo,
              state: 'all',
              per_page: 100
            });
            
            // Filtrer les PRs de la semaine
            const weekPRs = prs.data.filter(pr => 
              new Date(pr.created_at) >= weekAgo
            );
            
            // Analyser les workflows
            const successfulRuns = workflowRuns.data.workflow_runs.filter(r => r.conclusion === 'success').length;
            const failedRuns = workflowRuns.data.workflow_runs.filter(r => r.conclusion === 'failure').length;
            const totalRuns = workflowRuns.data.workflow_runs.length;
            
            const stats = {
              commits: commits.data.length,
              workflowRuns: totalRuns,
              successfulRuns,
              failedRuns,
              issues: issues.data.filter(i => !i.pull_request).length,
              pullRequests: weekPRs.length,
              successRate: totalRuns > 0 ? ((successfulRuns / totalRuns) * 100).toFixed(1) : 0
            };
            
            console.log('ğŸ“Š Statistiques:', JSON.stringify(stats, null, 2));
            
            // Sauvegarder dans les outputs
            const fs = require('fs');
            fs.writeFileSync('weekly-stats.json', JSON.stringify(stats, null, 2));
            
            return stats;
      
      - name: ğŸ“ GÃ©nÃ©rer le rapport hebdomadaire
        run: |
          # Lire les statistiques
          STATS=$(cat weekly-stats.json)
          
          # GÃ©nÃ©rer le rapport
          cat > weekly-report.md << 'EOFMD'
          # ğŸ“Š Rapport Hebdomadaire - Semaine du $(date -d "7 days ago" +"%d/%m/%Y") au $(date +"%d/%m/%Y")
          
          ## ğŸ“ˆ Vue d'ensemble
          
          Voici le rÃ©sumÃ© de l'activitÃ© de la semaine derniÃ¨re sur le projet.
          
          ## ğŸ¯ MÃ©triques ClÃ©s
          
          EOFMD
          
          # Extraire et afficher les stats
          python3 << 'EOF'
          import json
          
          with open('weekly-stats.json', 'r') as f:
              stats = json.load(f)
          
          report = f"""
          | MÃ©trique | Valeur |
          |----------|--------|
          | ğŸ’» Commits | {stats['commits']} |
          | ğŸ”„ Workflows exÃ©cutÃ©s | {stats['workflowRuns']} |
          | âœ… Workflows rÃ©ussis | {stats['successfulRuns']} |
          | âŒ Workflows Ã©chouÃ©s | {stats['failedRuns']} |
          | ğŸ“ Issues | {stats['issues']} |
          | ğŸ”€ Pull Requests | {stats['pullRequests']} |
          | ğŸ“Š Taux de rÃ©ussite | {stats['successRate']}% |
          
          ## ğŸ¨ Visualisation
          
          ### Statut des Workflows
          """
          
          # Barre de progression ASCII
          success_rate = float(stats['successRate'])
          bar_length = 20
          filled = int(bar_length * success_rate / 100)
          bar = 'â–ˆ' * filled + 'â–‘' * (bar_length - filled)
          
          report += f"\n```\n{bar} {success_rate}%\n```\n"
          
          # Ã‰mojis selon le taux de rÃ©ussite
          if success_rate >= 90:
              report += "\nğŸŸ¢ **Excellent!** Le taux de rÃ©ussite est trÃ¨s Ã©levÃ©.\n"
          elif success_rate >= 70:
              report += "\nğŸŸ¡ **Bien** Le taux de rÃ©ussite est acceptable.\n"
          else:
              report += "\nğŸ”´ **Attention!** Le taux de rÃ©ussite est faible.\n"
          
          report += f"""
          ## ğŸ’¡ Faits Marquants
          
          - ğŸ“Š **ActivitÃ©:** {stats['commits']} commits cette semaine
          - ğŸ”„ **CI/CD:** {stats['workflowRuns']} exÃ©cutions de workflows
          - ğŸ“ **Collaboration:** {stats['issues']} issues et {stats['pullRequests']} PRs
          
          ## ğŸ¯ Recommandations
          
          """
          
          # Recommandations basÃ©es sur les stats
          if stats['failedRuns'] > 0:
              report += "- âš ï¸ Investiguer les workflows Ã©chouÃ©s pour amÃ©liorer la stabilitÃ©\n"
          
          if stats['commits'] == 0:
              report += "- ğŸ’¡ Aucun commit cette semaine - projet en pause?\n"
          elif stats['commits'] > 50:
              report += "- ğŸ”¥ Beaucoup d'activitÃ© cette semaine!\n"
          
          if success_rate < 80:
              report += "- ğŸ”§ AmÃ©liorer la qualitÃ© du code pour rÃ©duire les Ã©checs\n"
          
          report += """
          ## ğŸ“… Prochaine Ã‰tape
          
          - Continuer le dÃ©veloppement
          - Surveiller les mÃ©triques de performance
          - Maintenir un bon taux de rÃ©ussite des workflows
          
          ---
          
          *Rapport gÃ©nÃ©rÃ© automatiquement le $(date)*
          """
          
          with open('weekly-report.md', 'a') as f:
              f.write(report)
          
          print(report)
          EOF
      
      - name: ğŸ“§ PrÃ©parer le contenu de l'email
        run: |
          # Convertir le markdown en texte simple pour l'email
          cat weekly-report.md | sed 's/#//g' | sed 's/\*\*//g' > weekly-report.txt
          
          echo "ğŸ“§ Rapport prÃªt Ã  Ãªtre envoyÃ©"
      
      - name: ğŸ“Š CrÃ©er un graphique des tendances
        run: |
          python3 << 'EOF'
          import json
          
          # Lire les stats
          with open('weekly-stats.json', 'r') as f:
              stats = json.load(f)
          
          # CrÃ©er un graphique ASCII simple
          print("\nğŸ“Š GRAPHIQUE DE TENDANCE")
          print("=" * 50)
          
          metrics = {
              'Commits': stats['commits'],
              'Workflows': stats['workflowRuns'],
              'Issues': stats['issues'],
              'PRs': stats['pullRequests']
          }
          
          max_value = max(metrics.values()) if max(metrics.values()) > 0 else 1
          
          for name, value in metrics.items():
              bar_length = int((value / max_value) * 30)
              bar = 'â–ˆ' * bar_length
              print(f"{name:12} {bar} {value}")
          
          print("=" * 50)
          EOF
      
      - name: ğŸ“¤ Upload du rapport
        uses: actions/upload-artifact@v3
        with:
          name: weekly-report-$(date +"%Y%m%d")
          path: |
            weekly-report.md
            weekly-report.txt
            weekly-stats.json
          retention-days: 90
      
      - name: ğŸ’¾ Sauvegarder le rapport dans le repo
        run: |
          # CrÃ©er un dossier pour les rapports si il n'existe pas
          mkdir -p reports
          
          # Copier le rapport avec la date
          cp weekly-report.md reports/weekly-report-$(date +"%Y%m%d").md
          
          echo "ğŸ“ Rapport sauvegardÃ© dans reports/"
      
      - name: ğŸ“Š Afficher le rÃ©sumÃ©
        run: |
          echo "================================"
          echo "ğŸ“Š WEEKLY REPORT GENERATED"
          echo "================================"
          cat weekly-report.txt
          echo "================================"
          echo ""
          echo "âœ… Rapport gÃ©nÃ©rÃ© avec succÃ¨s!"
          echo "ğŸ“§ PrÃªt Ã  Ãªtre envoyÃ© par email"
      
      # Dans un vrai projet, vous enverriez l'email ici
      # Voir la configuration d'envoi d'email sÃ©parÃ©e
  
  # ==================== RÃ‰SUMÃ‰ ====================
  summary:
    name: ğŸ“‹ RÃ©sumÃ©
    runs-on: ubuntu-latest
    needs: [generate-report]
    if: always()
    
    steps:
      - name: ğŸ“‹ Afficher le rÃ©sumÃ©
        run: |
          echo "================================"
          echo "ğŸ“Š WEEKLY REPORT SUMMARY"
          echo "================================"
          echo "Status: ${{ needs.generate-report.result }}"
          echo "Date: $(date)"
          echo "================================"
          
          if [ "${{ needs.generate-report.result }}" = "success" ]; then
            echo "âœ… Rapport hebdomadaire gÃ©nÃ©rÃ© avec succÃ¨s"
            echo "ğŸ“§ Le rapport est disponible dans les artifacts"
          else
            echo "âŒ Ã‰chec de la gÃ©nÃ©ration du rapport"
          fi
