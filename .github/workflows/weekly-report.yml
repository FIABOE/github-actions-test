name: Weekly Report

# S'ex√©cute tous les lundis √† 9h
on:
  schedule:
    - cron: '0 9 * * 1'  # Tous les lundis √† 9h UTC
  workflow_dispatch:  # Permet de lancer manuellement pour tester


permissions:
  contents: write
  issues: read
  pull-requests: read

jobs:
  generate-report:
    name:  G√©n√©ration du Rapport
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Configuration Python
        uses: actions/setup-python@v5 # CORRECTIF 2 : Mise √† jour vers v5 (plus stable)
        with:
          python-version: '3.11'
      
      - name: Collecter les donn√©es de la semaine
        id: collect_data
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            
            // R√©cup√©ration des donn√©es via l'API GitHub
            const commits = await github.rest.repos.listCommits({
              owner, repo, since: weekAgo.toISOString(), per_page: 100
            });
            
            const workflowRuns = await github.rest.actions.listWorkflowRunsForRepo({
              owner, repo, created: `>=${weekAgo.toISOString().split('T')[0]}`, per_page: 100
            });
            
            const stats = {
              commits: commits.data.length,
              workflowRuns: workflowRuns.data.workflow_runs.length,
              successRate: workflowRuns.data.workflow_runs.length > 0 ? 
                ((workflowRuns.data.workflow_runs.filter(r => r.conclusion === 'success').length / workflowRuns.data.workflow_runs.length) * 100).toFixed(1) : 0
            };
            
            const fs = require('fs');
            fs.writeFileSync('weekly-stats.json', JSON.stringify(stats, null, 2));
            return stats;

      - name: G√©n√©rer le rapport Markdown
        run: |
          echo "# üìä Rapport d'Activit√© Hebdomadaire" > weekly-report.md
          echo "G√©n√©r√© le $(date)" >> weekly-report.md
          cat weekly-stats.json >> weekly-report.md

      - name: Upload du rapport
        uses: actions/upload-artifact@v4 # CORRECTIF 3 : Passage de v3 √† v4 pour supprimer l'erreur de d√©pr√©ciation
        with:
          name: weekly-report-${{ github.run_id }}
          path: |
            weekly-report.md
            weekly-stats.json
          retention-days: 90

  summary:
    name: R√©sum√©
    runs-on: ubuntu-latest
    needs: [generate-report]
    if: always() # CORRECTIF 4 : S'assure que le r√©sum√© s'affiche m√™me si le rapport √©choue
    steps:
      - name: Afficher le r√©sultat final
        run: |
          echo "================================"
          echo " STATUT FINAL : ${{ needs.generate-report.result }}"
          echo "================================"
          if [ "${{ needs.generate-report.result }}" = "success" ]; then
            echo " Rapport pr√™t dans les Artifacts."
          else
            echo "‚ùå Erreur lors de la g√©n√©ration."
          fi