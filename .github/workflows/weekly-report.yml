name: Weekly Report

# S'ex√©cute tous les lundis √† 9h
on:
  schedule:
    - cron: '0 9 * * 1'  # Tous les lundis √† 9h UTC
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  generate-report:
    name:  G√©n√©ration du Rapport
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name:  Configuration Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name:  Collecter les donn√©es de la semaine
        id: collect_data
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Calculer la p√©riode (7 derniers jours)
            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            
            console.log(` P√©riode: ${weekAgo.toISOString()} ‚Üí ${now.toISOString()}`);
            
            // R√©cup√©rer les commits de la semaine
            const commits = await github.rest.repos.listCommits({
              owner,
              repo,
              since: weekAgo.toISOString(),
              per_page: 100
            });
            
            // R√©cup√©rer les workflows runs
            const workflowRuns = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              created: `>=${weekAgo.toISOString().split('T')[0]}`,
              per_page: 100
            });
            
            // R√©cup√©rer les issues de la semaine
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              since: weekAgo.toISOString(),
              state: 'all',
              per_page: 100
            });
            
            // R√©cup√©rer les Pull Requests
            const prs = await github.rest.pulls.list({
              owner,
              repo,
              state: 'all',
              per_page: 100
            });
            
            // Filtrer les PRs de la semaine
            const weekPRs = prs.data.filter(pr => 
              new Date(pr.created_at) >= weekAgo
            );
            
            // Analyser les workflows
            const successfulRuns = workflowRuns.data.workflow_runs.filter(r => r.conclusion === 'success').length;
            const failedRuns = workflowRuns.data.workflow_runs.filter(r => r.conclusion === 'failure').length;
            const totalRuns = workflowRuns.data.workflow_runs.length;
            
            const stats = {
              commits: commits.data.length,
              workflowRuns: totalRuns,
              successfulRuns,
              failedRuns,
              issues: issues.data.filter(i => !i.pull_request).length,
              pullRequests: weekPRs.length,
              successRate: totalRuns > 0 ? ((successfulRuns / totalRuns) * 100).toFixed(1) : 0
            };
            
            console.log('Statistiques:', JSON.stringify(stats, null, 2));
            
            // Sauvegarder dans les outputs
            const fs = require('fs');
            fs.writeFileSync('weekly-stats.json', JSON.stringify(stats, null, 2));
            
            return stats;
      
      - name:  G√©n√©rer le rapport hebdomadaire
        run: |
          # Lire les statistiques
          STATS=$(cat weekly-stats.json)
          
          # G√©n√©rer le rapport
          cat > weekly-report.md << 'EOFMD'
          #  Rapport Hebdomadaire - Semaine du $(date -d "7 days ago" +"%d/%m/%Y") au $(date +"%d/%m/%Y")
          
          ##  Vue d'ensemble
          
          Voici le r√©sum√© de l'activit√© de la semaine derni√®re sur le projet.
          
          ##  M√©triques Cl√©s
          
          EOFMD
          
          # Extraire et afficher les stats
          python3 << 'EOF'
          import json
          
          with open('weekly-stats.json', 'r') as f:
              stats = json.load(f)
          
          report = f"""
          | M√©trique | Valeur |
          |----------|--------|
          |  Commits | {stats['commits']} |
          |  Workflows ex√©cut√©s | {stats['workflowRuns']} |
          |  Workflows r√©ussis | {stats['successfulRuns']} |
          |  Workflows √©chou√©s | {stats['failedRuns']} |
          |  Issues | {stats['issues']} |
          |  Pull Requests | {stats['pullRequests']} |
          |  Taux de r√©ussite | {stats['successRate']}% |
          
          ##  Visualisation
          
          ### Statut des Workflows
          """
          
          # Barre de progression ASCII
          success_rate = float(stats['successRate'])
          bar_length = 20
          filled = int(bar_length * success_rate / 100)
          bar = '‚ñà' * filled + '‚ñë' * (bar_length - filled)
          
          report += f"\n```\n{bar} {success_rate}%\n```\n"
          
          # √âmojis selon le taux de r√©ussite
          if success_rate >= 90:
              report += "\nüü¢ **Excellent!** Le taux de r√©ussite est tr√®s √©lev√©.\n"
          elif success_rate >= 70:
              report += "\nüü° **Bien** Le taux de r√©ussite est acceptable.\n"
          else:
              report += "\nüî¥ **Attention!** Le taux de r√©ussite est faible.\n"
          
          report += f"""
          ## üí° Faits Marquants
          
          -  **Activit√©:** {stats['commits']} commits cette semaine
          -  **CI/CD:** {stats['workflowRuns']} ex√©cutions de workflows
          - **Collaboration:** {stats['issues']} issues et {stats['pullRequests']} PRs
          
          ##  Recommandations
          
          """
          
          # Recommandations bas√©es sur les stats
          if stats['failedRuns'] > 0:
              report += "-  Investiguer les workflows √©chou√©s pour am√©liorer la stabilit√©\n"
          
          if stats['commits'] == 0:
              report += "-  Aucun commit cette semaine - projet en pause?\n"
          elif stats['commits'] > 50:
              report += "-  Beaucoup d'activit√© cette semaine!\n"
          
          if success_rate < 80:
              report += "-  Am√©liorer la qualit√© du code pour r√©duire les √©checs\n"
          
          report += """
          ## Prochaine √âtape
          
          - Continuer le d√©veloppement
          - Surveiller les m√©triques de performance
          - Maintenir un bon taux de r√©ussite des workflows
          
          ---
          
          *Rapport g√©n√©r√© automatiquement le $(date)*
          """
          
          with open('weekly-report.md', 'a') as f:
              f.write(report)
          
          print(report)
          EOF
      
      - name: Pr√©parer le contenu de l'email
        run: |
          # Convertir le markdown en texte simple pour l'email
          cat weekly-report.md | sed 's/#//g' | sed 's/\*\*//g' > weekly-report.txt
          
          echo " Rapport pr√™t √† √™tre envoy√©"
      
      - name:  Cr√©er un graphique des tendances
        run: |
          python3 << 'EOF'
          import json
          
          # Lire les stats
          with open('weekly-stats.json', 'r') as f:
              stats = json.load(f)
          
          # Cr√©er un graphique ASCII simple
          print("\n GRAPHIQUE DE TENDANCE")
          print("=" * 50)
          
          metrics = {
              'Commits': stats['commits'],
              'Workflows': stats['workflowRuns'],
              'Issues': stats['issues'],
              'PRs': stats['pullRequests']
          }
          
          max_value = max(metrics.values()) if max(metrics.values()) > 0 else 1
          
          for name, value in metrics.items():
              bar_length = int((value / max_value) * 30)
              bar = '‚ñà' * bar_length
              print(f"{name:12} {bar} {value}")
          
          print("=" * 50)
          EOF
      
      - name: Upload du rapport
        uses: actions/upload-artifact@v3
        with:
          name: weekly-report-$(date +"%Y%m%d")
          path: |
            weekly-report.md
            weekly-report.txt
            weekly-stats.json
          retention-days: 90
      
      - name:  Sauvegarder le rapport dans le repo
        run: |
          # Cr√©er un dossier pour les rapports si il n'existe pas
          mkdir -p reports
          
          # Copier le rapport avec la date
          cp weekly-report.md reports/weekly-report-$(date +"%Y%m%d").md
          
          echo " Rapport sauvegard√© dans reports/"
      
      - name:  Afficher le r√©sum√©
        run: |
          echo "================================"
          echo "WEEKLY REPORT GENERATED"
          echo "================================"
          cat weekly-report.txt
          echo "================================"
          echo ""
          echo " Rapport g√©n√©r√© avec succ√®s!"
          echo " Pr√™t √† √™tre envoy√© par email"
      
      # Dans un vrai projet, vous enverriez l'email ici
      # Voir la configuration d'envoi d'email s√©par√©e
  
  # ==================== R√âSUM√â ====================
  summary:
    name:  R√©sum√©
    runs-on: ubuntu-latest
    needs: [generate-report]
    if: always()
    
    steps:
      - name:  Afficher le r√©sum√©
        run: |
          echo "================================"
          echo " WEEKLY REPORT SUMMARY"
          echo "================================"
          echo "Status: ${{ needs.generate-report.result }}"
          echo "Date: $(date)"
          echo "================================"
          
          if [ "${{ needs.generate-report.result }}" = "success" ]; then
            echo " Rapport hebdomadaire g√©n√©r√© avec succ√®s"
            echo " Le rapport est disponible dans les artifacts"
          else
            echo " √âchec de la g√©n√©ration du rapport"
          fi
